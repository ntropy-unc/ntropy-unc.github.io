<!DOCTYPE html>
<html lang="en-US">
		<head>
				<meta charset="UTF-8">

				<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Itanic - OpenCTF at DEFCON 26 | Ntropy - UNC</title>
<meta name="generator" content="Jekyll v3.9.2" />
<meta property="og:title" content="Itanic - OpenCTF at DEFCON 26" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="If there‚Äôs something off here, it‚Äôs probably because I wrote it in broken stints. - dreamist" />
<meta property="og:description" content="If there‚Äôs something off here, it‚Äôs probably because I wrote it in broken stints. - dreamist" />
<link rel="canonical" href="http://localhost:4000/exploit/pwn/x86/x64/writeup/post/2018/08/17/WriteUp-OpenCTF-Itanic.html" />
<meta property="og:url" content="http://localhost:4000/exploit/pwn/x86/x64/writeup/post/2018/08/17/WriteUp-OpenCTF-Itanic.html" />
<meta property="og:site_name" content="Ntropy - UNC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-17T20:08:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Itanic - OpenCTF at DEFCON 26" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2018-08-17T20:08:00-04:00","datePublished":"2018-08-17T20:08:00-04:00","description":"If there‚Äôs something off here, it‚Äôs probably because I wrote it in broken stints. - dreamist","headline":"Itanic - OpenCTF at DEFCON 26","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/exploit/pwn/x86/x64/writeup/post/2018/08/17/WriteUp-OpenCTF-Itanic.html"},"url":"http://localhost:4000/exploit/pwn/x86/x64/writeup/post/2018/08/17/WriteUp-OpenCTF-Itanic.html"}</script>
<!-- End Jekyll SEO tag -->

				<meta name="description" content="The official website for ntropy, UNC Chapel Hill CTF Team"/>
				<meta name="viewport" content="width=device-width, initial-scale=1">
				<meta name="theme-color" content="#157878">
				<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
				<link rel="stylesheet" href="/assets/css/style.css?v=">


				<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"></link>
				<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		</head>
		<body>
				<div class="container-fluid">
						<div class="row">
								<div class="col"></div>
								<div class="col-8" id="main_col">

								<!-- Navigation -->
								<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
										<a class="navbar-brand" href="https://ntropy-unc.github.io/">
												<img class="logo" alt="logo" src="/img/logo.svg">
										</a>
										<ul class="navbar-nav mr-auto">
												<li class="nav-item">
														<a class="nav-link" href="/about/">About</a>
												</li>

												<li class="nav-item">
														<a class="nav-link" href="/writeups/">Write Ups</a>
												</li>
												<li class="nav-item">
														<a class="nav-link" href="/events/">Events</a>
												</li>
												<li class="nav-item">
														<a class="nav-link" href="/resources/">Resources</a>
												</li>
										</ul>
								</nav>

				<section class="main-content">
						<blockquote>
  <p>If there‚Äôs something off here, it‚Äôs probably because I wrote it in broken stints. - dreamist</p>
</blockquote>

<p>During my first time at DEFCON I got to play in one of the several CTFs.
Not knowing that Warlock Gamez CTF could facilitate the participation of remote team members,
I went into OpenCTF largely alone, and occasionally with the additional help of my coworker
(who left his laptop at home. üòõ).</p>

<p>Itanic was one of the very few pwnable challenges available for
most of the time the competition ran, and the challenge I struggled with the most, only to
fail solving in time. So this will serve as both a ‚Äúwhat I did‚Äù as well as a 
‚Äúwhat I learned to do better next time‚Äù.</p>

<p>There‚Äôs additional benefit too in understanding what I missed since now
<code class="language-plaintext highlighter-rouge">soen</code> has released his OpenCTF binaries‚Äô 
<a href="https://github.com/soen-vanned/OpenCTF2018_soen">sources</a> on Github.</p>

<p>Tools used:</p>
<ul>
  <li>
<a href="https://github.com/radare/radare2">radare2</a> for disassembly</li>
  <li>GDB w/<a href="https://github.com/hugsy/gef">GEF</a> for debugging</li>
  <li>Python for scripting</li>
</ul>

<h1 id="preface">Preface</h1>
<p>There‚Äôs a familiarity with <a href="https://en.wikipedia.org/wiki/Calling_convention">calling conventions</a>
 assumed in this blog post,
however this may be just a fine time as any other to explain.
Compiled C programs tend to follow a consistent scheme for how
functions in assembly should receive parameters and be called.</p>

<p>Typically on Linux, 64-bit x86 programs will follow the 
<a href="https://en.wikipedia.org/wiki/X86_calling_conventions#System_V_AMD64_ABI">System V AMD64 ABI</a>. 
What this means is that the first six integer arguments to a function are passed into a function
using registers <code class="language-plaintext highlighter-rouge">RDI</code>, <code class="language-plaintext highlighter-rouge">RSI</code>, <code class="language-plaintext highlighter-rouge">RDX</code>, <code class="language-plaintext highlighter-rouge">RCX</code>, <code class="language-plaintext highlighter-rouge">R8</code>, and <code class="language-plaintext highlighter-rouge">R9</code>, in that order, before
additional arguments are pushed onto the stack. This is how you identify what the arguments
are passed into a called function, and I use this understanding later
to match a function call in <code class="language-plaintext highlighter-rouge">x86_64</code> disassembly to its arguments in source code.</p>

<h1 id="itanic">Itanic</h1>

<p>The challenge came in a <a href="https://github.com/n00bSec/CTF-archive/tree/master/OpenCTF/Itanic">tar file</a>, with the following readme.txt.</p>

<blockquote>
  <p>Sink the Itanic</p>

  <p>A: This is hard
B: LostKng.enc is not part of the Challenge, it‚Äôs just a fun game included if you get frustrated.
-soen</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">A</code> was right, and <code class="language-plaintext highlighter-rouge">B</code> I completely forgot about before long. But I never got frustrated
in a way that I wasn‚Äôt still willing to go back to some easier challenge for a while.</p>

<p>The entirety of the TAR file‚Äôs contents were:</p>
<ul>
  <li>itanic: binary to reverse/pwn</li>
  <li>
<code class="language-plaintext highlighter-rouge">hello_world.enc</code>: An encrypted binary file? More on this later.</li>
  <li><code class="language-plaintext highlighter-rouge">quine.enc</code></li>
  <li><code class="language-plaintext highlighter-rouge">printer.enc</code></li>
  <li><code class="language-plaintext highlighter-rouge">dock.enc</code></li>
  <li><code class="language-plaintext highlighter-rouge">LostKng.enc</code></li>
</ul>

<p>Running the <code class="language-plaintext highlighter-rouge">itanic</code> binary presents us with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ Itanic v 1.005003 ]
Welcome to HMS Operating System
Written on a custom (ish) architecture.
This operating system is perfectly
secure (unhackable like BitFi).

Using the Itanic processor, the superior
processor for the unsinkable HMS
operating system.


Main menu
1. Printer
2. Hello_world
3. Dock
4. Quine
5. Lost Kingdom (not part of challenge, but relaxing and fun!)
6. quit
</code></pre></div></div>

<p>From here I began to play with the menu options, and crack it open in a disassembler.
Before long I learned that each of these menu items essentially ran 
their respective <code class="language-plaintext highlighter-rouge">.enc</code> files as arguments to the binary. Ex: <code class="language-plaintext highlighter-rouge">itanic hello_world.enc</code>.</p>

<p>Each of these encrypted files began with <code class="language-plaintext highlighter-rouge">BOAT\x00\x00\x00\x00</code>, and
could be read in and executed as a program, carrying behaviors
to befit their naming. <code class="language-plaintext highlighter-rouge">hello_world</code> for example simply prints <code class="language-plaintext highlighter-rouge">hello world</code>.
<code class="language-plaintext highlighter-rouge">quine</code> and <code class="language-plaintext highlighter-rouge">printer.enc</code> however, print out <code class="language-plaintext highlighter-rouge">+</code>s and <code class="language-plaintext highlighter-rouge">-</code>s to form brainf‚Äìk programs.</p>

<p>If you‚Äôve never seen the <a href="https://en.wikipedia.org/wiki/Brainfuck">Brainf‚Äìk language</a> before,
it‚Äôs a programming language comprised completely
of eight special characters, emulating a machine with one byte pointer referencing memory and a program counter.
The program counter can land on any of the eight instructions, 
and perform the appropriate action before moving forward:</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">&gt;</code>: Increments the pointer by 1.</li>
  <li>
<code class="language-plaintext highlighter-rouge">&lt;</code>: Decrements the pointer by 1.</li>
  <li>
<code class="language-plaintext highlighter-rouge">+</code>: Increments the value beneath the pointer by 1.</li>
  <li>
<code class="language-plaintext highlighter-rouge">-</code>: Decrements the value beneath the pointer by 1.</li>
  <li>
<code class="language-plaintext highlighter-rouge">.</code>: Prints the character represented by the byte beneath the pointer.</li>
  <li>
<code class="language-plaintext highlighter-rouge">,</code>: Reads in a byte, storing the value beneath the pointer.</li>
  <li>
<code class="language-plaintext highlighter-rouge">[</code>: If the pointer dereferences to 0, jump to the next <code class="language-plaintext highlighter-rouge">]</code>.</li>
  <li>
<code class="language-plaintext highlighter-rouge">]</code>: If the pointer dereferences to a non-zero value, jump to the matching <code class="language-plaintext highlighter-rouge">[</code> instruction.</li>
</ul>

<p>I had been personally made somewhat familiar with it by solving <code class="language-plaintext highlighter-rouge">brain f--k</code> on 
<a href="http://pwnable.kr/play.php">Pwnable.kr</a> the week before I left for Las Vegas.
I imagined before long if I could get my own Brainf‚Äìk code to run in a similar fashion,
exploitation should be as straightforward as moving the data pointer to leak/overwrite a function pointer.</p>

<p><code class="language-plaintext highlighter-rouge">quine.enc</code> thus prints itself, and <code class="language-plaintext highlighter-rouge">printer.enc</code> prints out Brainf‚Äìk instructions to print the input it receives.</p>

<p>Further looking into the <code class="language-plaintext highlighter-rouge">main</code> function reveals that after reading
in the encrypted program and loading it, this program is ran in a form of Brainf‚Äìk VM
in the function at <code class="language-plaintext highlighter-rouge">0x4009ae</code>. Here a huge switch case is present that implements all of the
Brainf‚Äìk language, in addition to a few unique instructions to the programs it runs.
Attaching a debugger confirms that these programs carry encrypted Brainf‚Äìk-superset
payloads, and point us in the direction of reverse engineering the program loader
and binary format.</p>

<p><img src="/pics/OpenCTF/BrainfuckVM.png" alt="Brainf--k Instruction Implementation"></p>

<p>This much already took quite some time for me personally to reverse
in between working on other challenges, and it definitely only seems 
somewhat straightforward to me now in hindsight.</p>

<h1 id="loading-boat-files-with-dockenc-and-new-instructions">Loading BOAT files with Dock.enc and New Instructions</h1>
<p>I individually made sense of each of the given Brainf‚Äìk programs.
Since one of these would have to be my initial entryway into gaining
control of the data pointer or of the VM.</p>

<p>I found that since the vulnerability couldn‚Äôt have been in <code class="language-plaintext highlighter-rouge">hello_world.enc</code>,
<code class="language-plaintext highlighter-rouge">printer.enc</code>, or <code class="language-plaintext highlighter-rouge">quine.enc</code>, the opening must‚Äôve lied within <code class="language-plaintext highlighter-rouge">dock.enc</code>.</p>

<p>And so running <code class="language-plaintext highlighter-rouge">./itanic dock.enc</code> gives this prompt:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        [ Itanic v 1.005003 ]
        [ Your sextant is accurate! ]
        [ Casting off the anchor ]


Enter Dock Number:
</code></pre></div></div>

<p>Setting a breakpoint on <code class="language-plaintext highlighter-rouge">0x400ea3</code> and reading the string pointed to by <code class="language-plaintext highlighter-rouge">0x006d3dc0</code> can reveal
the underlying program.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef‚û§  x/a 0x006d3dc0
0x6d3dc0:       0x7ffff7bf9010
</code></pre></div></div>

<p><img src="" alt=""></p>

<p>And immediately it‚Äôs apparent that it‚Äôs not Brainf‚Äìk, but uses some of the additional instructions implemented
in the virtual machine. During competition, I only saw that uses of <code class="language-plaintext highlighter-rouge">?</code> and <code class="language-plaintext highlighter-rouge">#</code> stored quad words
in some variables and nulled their original storage locations in the memory buffer,
and <code class="language-plaintext highlighter-rouge">*</code> triggered a decryption routine that revealed the actual Brainf‚Äìk
we care about. After hitting the breakpoint a few times, the rest of the program should be revealed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef‚û§  x/s  0x7ffff7bf9022
0x7ffff7bf9022: "*&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++++++.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;++++++.[-]&gt;++++++++++[&lt;++++++++++&gt;-]&lt;+.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;++++.[-]&gt;+++[&lt;++++++++++&gt;-]&lt;++.[-]&gt;++++++[&lt;++++++++++&gt;-]&lt;++++++++.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;+.[-]&gt;+++++++++[&lt;++++++++++&gt;-]&lt;+++++++++.[-]&gt;++++++++++[&lt;++++++++++&gt;-]&lt;+++++++.[-]&gt;+++[&lt;++++++++++&gt;-]&lt;++.[-]&gt;+++++++[&lt;++++++++++&gt;-]&lt;++++++++.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;+++++++.[-]&gt;++++++++++[&lt;++++++++++&gt;-]&lt;+++++++++.[-]&gt;+++++++++[&lt;++++++++++&gt;-]&lt;++++++++.[-]&gt;++++++++++[&lt;++++++++++&gt;-]&lt;+.[-]&gt;", '+' &lt;repeats 11 times&gt;, "[&lt;++++++++++&gt;-]&lt;++++.[-]&gt;+++++[&lt;++++++++++&gt;-]&lt;++++++++.[-]&gt;+++[&lt;++++++++++&gt;-]&lt;++.[-]&gt;&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;++++++++&gt;&gt;&gt;+++++++[&lt;++++++++++&gt;-]&lt;+++++++++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++++&gt;&gt;&gt;+++++++[&lt;++++++++++&gt;-]&lt;+++++&gt;&gt;&gt;+++++++[&lt;++++++++++&gt;-]&lt;&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++++++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++++++&gt;&gt;&gt;++++++++[&lt;++++++++++&gt;-]&lt;+++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++&gt;&gt;&gt;++++++++[&lt;++++++++++&gt;-]&lt;++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;+++++++++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;++++++++&gt;&gt;&gt;++++++++[&lt;++++++++++&gt;-]&lt;+++++&gt;&gt;&gt;+++++++[&lt;++++++++++&gt;-]&lt;+++++++&gt;&gt;&gt;++++++[&lt;++++++++++&gt;-]&lt;++++++&gt;&gt;++++++++++&gt;&gt;+&gt;&gt;+[&lt;[&gt;&gt;+&gt;+&lt;&lt;&lt;-]&gt;&gt;&gt;[&lt;&lt;&lt;+&gt;&gt;&gt;-]&lt;+&gt;", '+' &lt;repeats 16 times&gt;, "&gt;&gt;+&lt;&lt;&lt;[&gt;&gt;+&lt;&lt;-]&gt;&gt;[&gt;-]&gt;[&gt;&lt;&lt;&lt;&lt;+&gt;[-]&gt;&gt;-&gt;]&lt;+&lt;&lt;[&gt;-[&gt;-]&gt;[&gt;&lt;&lt;&lt;&lt;+&gt;[-]+&gt;&gt;-&gt;]&lt;+&lt;&lt;-]&gt;[-]&gt;-&lt;&lt;&lt;[&gt;,[&gt;+&gt;+&lt;&lt;-]&gt;&gt;[&lt;&lt;+&gt;&gt;-]&lt;&lt;&lt;&lt;&lt;[&gt;&gt;&gt;&gt;&gt;&gt;+&gt;+&lt;&lt;&lt;&lt;&lt;&lt;&lt;-]&gt;&gt;&gt;&gt;&gt;&gt;&gt;[&lt;&lt;&lt;&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;&gt;&gt;&gt;-]&lt;[", '&lt;' &lt;repeats 40 times&gt;, "+", '&gt;' &lt;repeats 40 times&gt;, "-]", '&lt;' &lt;repeats 42 times&gt;, "&gt;&gt;[[&gt;&gt;]+[&lt;&lt;]&gt;&gt;-]+[&gt;&gt;]&lt;[&lt;[&lt;&lt;]&gt;+&lt;", '&gt;' &lt;repeats 41 times&gt;, "+", '&lt;' &lt;repeats 41 times&gt;, "&gt;&gt;[&gt;&gt;]&lt;-]&lt;[&lt;&lt;]&gt;[&gt;[&gt;&gt;]&lt;+&lt;[&lt;&lt;]&gt;-]&gt;[&gt;&gt;]&lt;&lt;[-&lt;&lt;]", '&gt;' &lt;repeats 40 times&gt;, "[-&gt;-&lt;]+&gt;[&lt;-&gt;[-]]&lt;[&gt;+&lt;[-]]+&gt;[&lt;-&gt;-]+&lt;[&gt;&gt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;&gt;&gt;&gt;&gt;[&lt;&lt;&lt;&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;&gt;&gt;&gt;-]&lt;-&lt;[-]]&gt;[-]&lt;&lt;&lt;&lt;&lt;[&gt;&gt;&gt;&gt;+&gt;+&lt;&lt;&lt;&lt;&lt;-]&gt;&gt;&gt;&gt;&gt;[&lt;&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;&gt;-]+[&lt;+&gt;-]&lt;&lt;&lt;&lt;&lt;[-]&gt;&gt;&gt;&gt;[&lt;&lt;&lt;&lt;+&gt;&gt;&gt;&gt;-]&lt;[-]&lt;[-]&lt;+&gt;]&lt;-]&lt;[-],&lt;[&gt;&gt;+&gt;+&lt;&lt;&lt;-]&gt;&gt;&gt;[&lt;&lt;&lt;+&gt;&gt;&gt;-]+&lt;[-&gt;-&lt;]+&gt;[&lt;-&gt;[-]]+&lt;[&gt;&gt;&gt;++++++++[&lt;++++++++++&gt;-]&lt;++++++++.![-]&lt;-&lt;[-]]&gt;[-]\n"
</code></pre></div></div>

<p>This program can now be dumped to memory with GDB‚Äôs <code class="language-plaintext highlighter-rouge">dump</code> function.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dump binary memory dock.bf 0x7ffff7bf9022 0x7ffff7bf97b9
</code></pre></div></div>

<p>Once dumped, the program can be understood in two parts.
The first prints out the prompt for a dock number,
while the second reads in the input to match against a secret password.
I found it convenient to determine the password by running the second part of the program
in a <a href="https://copy.sh/brainfuck">Brainf‚Äìk visualizer</a>.</p>

<p><img src="/pics/OpenCTF/DockFeesAreDumb.png" alt="Found The Password!"></p>

<p>Entering this password and supplying an additional newline gives us access to the program loader!
And so continuing the effort of reversing the program loader was an absolute must to move forward.</p>

<h1 id="some-frustration">Some Frustration</h1>

<p>What made my frustration escalate at this point was that a new version of the binary was released
just as began to make some progress on understanding the loader.
The older version of the binary dynamically linked
glibc and made identifying <code class="language-plaintext highlighter-rouge">libc</code> functions easy, 
but the new version had statically linked <code class="language-plaintext highlighter-rouge">glibc</code> functions
 and thus doubled the work I had to do in function identification wherever I couldn‚Äôt
quickly port over the old symbols I marked.</p>

<p>Function identification was perhaps my biggest initial barrier in working through the binary
file format reversing.</p>

<blockquote>
  <p>It‚Äôs only in doing this writeup now that I realized I ported some symbols incorrectly,
and misidentified <code class="language-plaintext highlighter-rouge">memcpy</code> as <code class="language-plaintext highlighter-rouge">memset</code>, adding a great deal of confusion to my reversing efforts.</p>
</blockquote>

<h1 id="failing-to-reverse-the-file-format">Failing to Reverse the File Format</h1>

<p>The function <code class="language-plaintext highlighter-rouge">@0x401282</code> I had renamed to <code class="language-plaintext highlighter-rouge">sub.LoadProgram</code>.
This function is passed a pointer to the encrypted binary file read into memory.
From reading it‚Äôs disassembly, it became clear that it cleared 0x3c bytes
of space on the stack, and then loaded a quad word (8 bytes in length) from
a 0x50 byte offset into the loaded binary file to pass into <code class="language-plaintext highlighter-rouge">malloc</code> as a 
size argument. I didn‚Äôt mark this down, but this should indicate that this member
is some form of size.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binary_format_struct {
...
0x50: uint64_t size
}
</code></pre></div></div>

<p>Beyond this, the first two functions called were obviously involved in some kind of encryption,
but I couldn‚Äôt identify the encryption scheme used, or what I could do besides setting a breakpoint
after to get some additional information on it.</p>

<h2 id="encryption">Encryption</h2>
<p>The first encryption-related function took as an argument a pointer to 
data at a <code class="language-plaintext highlighter-rouge">0x20</code> offset within the read binary file.
This function has two main loops performing some math that was and perhaps would still be beyond me,
using a long list of large constants on the stack.</p>

<p><img src="/pics/OpenCTF/KeyScheduleConstants.png" alt="Constants on Stack"></p>

<p>The second encryption-related function contains loops using two additional math functions
I didn‚Äôt find fruitful to reverse. And this is where I attempted to shamefully ask the organizers
for my first hint of the event, to which there may have been miscommunication.
I had heard the author explain that the encryption was custom, but this wasn‚Äôt so.</p>

<p>The large constants on the stack in the first function happened to be a useful hint
for Googling. Shortly after the CTF ended I found from an archived textbook that these constants 
were used in AES for key scheduling.
Looking for AES implementations on Github then, I found 
<a href="https://github.com/B-Con/crypto-algorithms/blob/master/aes.c">one written by Brad Conte</a>
that seemed to have all of the contants in a function that matched up very well
to the first encryption function, <code class="language-plaintext highlighter-rouge">aes_key_setup</code>. It turns out that this was the exact 
source copied for implementing the encryption in the Itanic challenge.</p>

<blockquote>
  <p>In repeating the same searches on Google now, maybe it‚Äôs my use of a VPN from my desktop,
but I wasn‚Äôt able to find neither the textbook nor the tiny-AES-c implementation as
Google results. I still feel rather convinced however that if I could have identified the sources
used in this manner I‚Äôd have been able to at least identify that the encryption was AES.</p>
</blockquote>

<p>Looking into <a href="https://github.com/soen-vanned/OpenCTF2018_soen/blob/master/itanic/itanic.c#L338">itanic‚Äôs source</a>, 
I can see now that the following function was <code class="language-plaintext highlighter-rouge">aes_decrypt_cbc</code>.
And I‚Äôm not sure I could‚Äôve identified CBC mode in the end anyhow.  ¬Ø\_(„ÉÑ)_/¬Ø
I simply need to study crypto more.
From this point I‚Äôll be relying on the sources to walk through the rest of the challenge.</p>

<p>From the setup to the <code class="language-plaintext highlighter-rouge">aes_key_setup</code> call, I see that at a <code class="language-plaintext highlighter-rouge">0x20</code> offset 
into the binary is a <code class="language-plaintext highlighter-rouge">key</code> parameter.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binary_format_struct {
...
0x20: char key[]
...
0x50: uint64_t size
}
</code></pre></div></div>

<p>Then, <code class="language-plaintext highlighter-rouge">aes_decrypt_cbc</code> is called with data beyond a <code class="language-plaintext highlighter-rouge">0x58</code> offset into the binary file
serving as input. The data at a <code class="language-plaintext highlighter-rouge">0x40</code> serves as an IV.
The decrypted output is stored in a large allocation made equal to the previously
determined size, and would turn out to be the encrypted Brainf‚Äìk code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binary_format_struct {
...
0x20: char key[]
0x40: char iv[]
0x50: uint64_t size
0x58: char encrypted_code[]
}
</code></pre></div></div>

<h2 id="hashing">Hashing</h2>
<p>During competition I wasn‚Äôt sure how to identify the last three math-related functions
in what I called <code class="language-plaintext highlighter-rouge">sub.LoadProgram</code>, but sources indicate that these are:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">SHA256_init(SHA_CTX *c)</code></li>
  <li><code class="language-plaintext highlighter-rouge">SHA256_Update(SHA_CTX *c, const void *data, size_t len)</code></li>
  <li><code class="language-plaintext highlighter-rouge">SHA256_Final(unsigned char *md, SHA_CTX *c)</code></li>
</ul>

<p>In that order, I can understand that following the decryption, these functions are
used to gather the SHA256 hash of the decrypted code, and determine if it matches
the first 0x20 bytes of the binary file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>binary_format_struct {
0x0: char hash[0x20]
0x20: char key[]
0x40: char iv[]
0x50: uint64_t size
0x58: char encrypted_code[]
}
</code></pre></div></div>

<p>This matches the <code class="language-plaintext highlighter-rouge">CodeBlob</code> struct that apparently represents the binary file following the magic quad word.</p>

<p>Following this, I expect that exploitation would follow in typical Brainf‚Äìk interpreter fashion.
If I write about the similarly named challenge on <a href="pwnable.kr/play.php">pwnable.kr</a>,
maybe then I can explain the straightforwardness of having an arbitrary relative read/write primitive.</p>

<h1 id="epilogue">Epilogue</h1>
<p>This was about as far as I‚Äôve continued to work on the challenge beyond OpenCTF‚Äôs end.</p>

<p>During the competition, for all of the hours I put into this challenge,
I could‚Äôve given more time to some other challenges
that would‚Äôve kept us higher up on the scoreboard as the end of the competition neared.
The intro warned that it was hard, but I simply took that as a challenge,
and I must admit that the gap in my personal crypto skillset made it a bit much for me after all.</p>

<p>I‚Äôd love to actually finish writing an exploit for this binary with my new understanding,
or even a decent unpacker for the binary format,
but that will likely not be anytime soon. If I do, there‚Äôll be a part 2.</p>


						<footer id="site-footer">
								<a href=""></a> is maintained by <a href=""></a>. 
								|  Contact : unc@dc919.net 
						</footer>
				</section>

						
								</div>
								<div class="col"></div>
						</div>
				</div>
		</body>
</html>
